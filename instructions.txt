
ИНТЕГРАЦИЯ С SONARQUBE

---------------------------------------------
1. ВЫПУСК САМОПОДПИСАННЫХ СЕРТИФИКАТОВ
---------------------------------------------


   ###################### 
   ВЫПУСК СЕРТИФКАТА НА GITLAB

   Нужно импортировать сертификат GitLab в Java, которая установлена на сервере SonarQube,
   иначе будет ошибка в Sonar "Could not validate GitLab url. Got an unexpected answer"

   Перед выпуском сертификата, сперва нужно куда-нибудь переместить тот сертификат 
   (открытая и закрытая его части), который был создан при установке GitLab 
   (он подходит для ГитКонвертер, но не подойдёт потом для SonarQube). 
   По умолчанию сертификаты в GitLab находятся в /etc/gitlab/ssl/

   Для выпуска сертификата при помощи OpenSSL нужно выполнить следующую команду:

   sudo openssl req -x509 -nodes -days 1825 -newkey rsa:2048 \
    -subj "/C=RU/ST=MO/L=MO/O=EXP/OU=EXP/CN=<gitlab-hostname>" \
    -addext "subjectAltName = DNS:<gitlab-hostname>, IP:<gitlab-hostip>" \
    -keyout <path-to-cert>/<gitlab-hostname>.key \
    -out <path-to-cert>/<gitlab-hostname>.crt

   , где:
    * <gitlab-hostname> - имя хоста gitlab, напр. gitlab.example.com
    * <gitlab-hostip> - ip хоста, на котором стоит gitlab (ip докер контейнера)
    * <path-to-cert> - путь, куда класть сертификаты (можно не указывать - в текущий каталог)
    * <user> - имя пользователя, в чей каталог будут сброшены сертификаты 

    обязательно поменять права на файлы chmod 644 <path-to-cert>/<gitlab-hostname>*

    Сгенерированные файлы сертификата (.crt, .key) помещаем в каталог /etc/gitlab/ssl/

    !!!ВНИМАНИЕ!!! на latest версии gitlab-EE ошибка чтения параметра letcencrypt
    ----
      В файле /etc/gitlab/gitlab.rb отключаем Let’s Encrypt, чтобы GitLab сам себе не выпустил сертификат и не затёр тот, который сгенерирован при помощи OpenSSL:
      letcencrypt['enable'] = false

      После этого нужно выполнить команду: sudo gitlab-ctl reconfigure. Дожидаемся окончания выполнения команды.
    ----


    ######################
    НАСТРОЙКА NGINX-PM

    добавляем SSL сертификат:
    название, напр. userv.ru
    подцепляем <gitlab-hostname>.key, <gitlab-hostname>.crt
    создаем proxy-host:
        domain names: <gitlab-hostname>
        scheme: https
        hostname: ip адрес машины с контейнером (напр 192.168.0.80)
        forward port: порт который проброшен на 443 порт контейнера (напр. 5443)



    ######################
    НАСТРОЙКА SONARQUBE

    1. Экспортируем сертификат с GitLab
    openssl s_client -connect <gitlab-hostname>:443 -showcerts </dev/null 2>/dev/null | openssl x509 -outform PEM > gitlab-cert.pem

    2. Или используем существующий
    cp /home/nikita/cert-gitlab-openssl/<gitlab-hostname>.crt gitlab-cert.pem
 
    3. Копируем сертификат в контейнер
    docker cp gitlab-cert.pem sonarqube-container:/tmp/gitlab-cert.pem

    4. Импортируем в Java truststore
    docker exec --user=root sonarqube-container keytool -importcert -keystore /opt/java/openjdk/lib/security/cacerts -storepass changeit -alias gitlab -file /tmp/gitlab-cert.pem -noprompt

    5. Перезапускаем SonarQube
    docker restart sonarqube-container



    ######################
    НАСТРОЙКА GITLAB-RUNNER (DOCKER)

    1. готовим каталоги:

    sudo mkdir -p /srv/gitlab-runner/{config,logs,certs}
    sudo chmod -R 755 /srv/gitlab-runner

    2. кладем сертификаты в раннер:
    openssl s_client -connect <gitlab-hostname>:443 -showcerts </dev/null 2>/dev/null | openssl x509 -outform PEM > gitlab.crt
     *  <gitlab-hostname> = gitlab.example.com 

    sudo cp /path/to/your/gitlab/certificate.crt /srv/gitlab-runner/certs/gitlab.crt

    3. Запускаем контейнер

    4. добавляем runner в gitlab, копируем токен для нового раннера

    5. Регистрируем runner
    docker exec -it gitlab-runner bash

    # Регистрируем runner с указанием сертификата
    gitlab-runner register  --url <gitlab-hostname>  --token <runner-token> --tls-ca-file "/etc/gitlab-runner/certs/gitlab.crt"
    указываем имя раннера (напр. docker-runner-1)
    выбираем executor (напр. docker или shell)
    если docker, выбираем базовый образ (напр. alpine:latest)
    
    6. Проверяем в gitlab наличие раннера

    7. Меняем конфиги раннера:
    [runners.docker]
      # Добавляем
      volumes = ["/cache", "/var/run/docker.sock:/var/run/docker.sock"]
      extra_hosts = ["<gitlab-hostname>:<ip-host>"] # <ip-host> - хост на котором стоит докер контейнер 
      dns = ["8.8.8.8", "8.8.4.4"]

---------------------------------------------
2. ИНТЕГРАЦИЯ GITLAB И SONARQUBE
---------------------------------------------

    1. Создаем отдельного пользователя в GitLab:
      name: sonarqube
      pass: {password}

      делаем ему через его учетную запись токен авторизации (можно сунуть все права чтобы не было проблем),
      токен сохраняем - он будет нужен для sonarqube

      Пользователя включаем в нужные проекты, чтобы был доступ до проектов.

    2. Создаем отдельного пользователя в SonarQube:
      name: gitlab
      pass: {password}

      делаем токен авторизации - он будет нужен для gitlab

    3. Коннектим gitlab в sonarqube 

       Администрирование - Интеграция с ALM - GitLab, там надо будет указывать хост gitlab и токен из п.1

       Конфигурация должна чекаться иначе идти в логи контейнера и разбираться, возможно не резолвится хост либо не прокинут сертификат в SonarQube

    4. Импортируем проект в sonarqube

    5. Заходим в проект - настройки проекта - Разрешения - чекаем флаги для юзера gitlab

    6. В gitlab в настройках проекта - CI/CD - задаем переменные: 
        
       SONAR_HOST_URL - URL хоста SonarQube (http://<ip-host>:9000)
       SONAR_TOKEN - токен из п. 2

    7. подкидываем .gitlab-ci.yml в корень проекта - проверяем pipeline по PR в ветку (текущая конфа на ветку develop), разбираем ошибки

    8. чтобы работали декораторы PR из Sonar следует обязательно проверить настройки:
      - Настройки проекта - Интеграция с платформой DevOps 
      - Администрирование - Общие - Images base URL / Server base URL
      - 
---------------------------------------------
3. ТЕКУЩАЯ ПРОБЛЕМАТИКА
---------------------------------------------
    1. GitLab-CE + SonarQube не умеет в анализ PR, делает анализ всей ветки, не умеет в декорацию PR (когда в gitlab в PR указан статус проверки)
    - решение - переход на gitlab-ee  в docker